#!/usr/bin/env bash
# Run the project without building it
set -Eeuo pipefail
START_TIME=$(date +%s.%N)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

# Find the booted simulator or use any available iPhone simulator
SIMULATOR_ID=$(xcrun simctl list devices booted iPhone | grep -o '[A-F0-9]\{8\}-[A-F0-9]\{4\}-[A-F0-9]\{4\}-[A-F0-9]\{4\}-[A-F0-9]\{12\}' | head -1)

if [ -z "$SIMULATOR_ID" ]; then
    # No booted simulator, find any available iPhone simulator
    SIMULATOR_ID=$(xcrun simctl list devices available iPhone | grep -o '[A-F0-9]\{8\}-[A-F0-9]\{4\}-[A-F0-9]\{4\}-[A-F0-9]\{4\}-[A-F0-9]\{12\}' | head -1)

    if [ -z "$SIMULATOR_ID" ]; then
        echo "‚ùå No iPhone simulator found"
        exit 1
    fi

    # Open Simulator app and boot the device
    echo "üì± Opening simulator"
    open -a Simulator

    echo "üîÑ Booting simulator $SIMULATOR_ID"
    xcrun simctl boot "$SIMULATOR_ID" 2>/dev/null || true
    sleep 3
else
    echo "üì± Using booted simulator $SIMULATOR_ID"
fi

# Look for the app in the DerivedData build products
APP_PATH=".DerivedData/Build/Products/Debug-iphonesimulator/RealityKitApp.app"
if [[ ! -d "$APP_PATH" ]]; then
    echo "‚ùå Could not find built app at: $APP_PATH"
    echo "   Run 'scripts/build' first to build the app"
    exit 1
fi

echo "üì¶ Installing RealityKitApp from: $APP_PATH"
xcrun simctl install "$SIMULATOR_ID" "$APP_PATH"

echo "üöÄ Launching RealityKitApp..."
xcrun simctl launch "$SIMULATOR_ID" "com.codeofhonor.RealityKitApp" "$@"

END_TIME=$(date +%s.%N)
ELAPSED_TIME=$(echo "$END_TIME - $START_TIME" | bc --mathlib | xargs printf "%.2f\n")
echo "‚úÖ Running in $ELAPSED_TIME seconds!"
